<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Source: components/wallet-creator.js &middot; Docs</title>
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  </head>
  <body>
    <div id="main">
      <h1 class="page-title">Source: components/wallet-creator.js</h1>
      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const Component = require('./component');
const Wallet = require('../types/wallet');

/**
 * Simple user interface for creating a {@link Wallet}.
 */
class WalletCreator extends Component {
  /**
   * Create an instance of the Wallet Creator.
   * @param  {Object} [settings={}] [description]
   * @return {Component}            Instance of the component.
   */
  constructor (settings = {}) {
    super(settings);

    this.settings = Object.assign({
      input: null,
      handle: 'fabric-wallet-creator'
    }, settings);

    this.wallet = new Wallet();
    this.state = {
      clock: 0,
      wallets: []
    };

    return this;
  }

  _submitFormWithData (event) {
    event.preventDefault();
    console.log('WHOA EVENT:', event);
  }

  _loadConfirmedPanel (html) {
    let steps = document.querySelector('maki-steps');
    let elements = document.querySelectorAll('.tab');

    for (let i = 0; i &lt; elements.length; i++) {
      let element = elements[i];
      if (parseInt(element.getAttribute('data-step')) === this.state.clock) {
        let content = element.querySelector('.content');
        content.innerHTML = `&lt;div class="ui message">
          &lt;h4 class="ui header">Ready to Generate Keys&lt;/h4>
          &lt;maki-canvas id="entropy-viewer">&lt;/maki-canvas>
          &lt;p>Ready to generate. &lt;a class="ui button" data-action="_loadGeneratorPanel">Generate&lt;/a>&lt;/p>
        &lt;/div>`;
      }
    }
  }

  _loadGeneratorPanel () {
    let self = this;
    let steps = this.querySelector('maki-steps');
    let elements = document.querySelectorAll('.tab');

    console.log('steps:', steps);

    for (let i = 0; i &lt; steps.length; i++) {
      let step = steps[i];
      if (i === this.state.clock) {
        step.className += ' active';
      }
    }

    for (let i = 0; i &lt; elements.length; i++) {
      let element = elements[i];
      if (parseInt(element.getAttribute('data-step')) === this.state.clock) {
        let content = element.querySelector('.content');
        let wallet = new Wallet();

        content.innerHTML = `&lt;div class="ui message">
          &lt;h4 class="ui header">Generating keys...&lt;/h4>
          &lt;maki-canvas id="entropy-viewer">&lt;/maki-canvas>
          &lt;p>&lt;div class="ui loading button">Generating...&lt;/div>&lt;p>
        &lt;/div>`;

        wallet._load().then(function (data) {
          let memory = {
            address: wallet.account.receiveAddress(),
            seed: wallet.wallet.master.mnemonic.phrase
          };

          window.app._POST('/wallets', memory).then(function (data) {
            console.log('data:', data);
            wallet.set('/wallets', [window.app.get(data)]);
            window.wallet = wallet;
            self._loadSuccessPanel();
          });
        });
      }
    }
  }

  _loadSuccessPanel () {
    let steps = document.querySelector('maki-steps');
    let elements = document.querySelectorAll('.tab');

    for (let i = 0; i &lt; elements.length; i++) {
      let element = elements[i];
      if (parseInt(element.getAttribute('data-step')) === this.state.clock) {
        let content = element.querySelector('.content');
        content.innerHTML = `&lt;div class="ui message">
          &lt;h4 class="ui header">Keys Generated&lt;/h4>
          &lt;code class="code">${window.wallet}&lt;/code>
          &lt;maki-canvas id="entropy-viewer">&lt;/maki-canvas>
          &lt;p>&lt;div class="ui green right labeled icon button" data-action="_loadStepTwo">Next Step &lt;i class="right chevron icon">&lt;/i>&lt;/div>&lt;p>
        &lt;/div>`;
      }
    }
  }

  _loadStepTwo () {
    let elements = document.querySelectorAll('.tab');

    this.state.clock = 1;

    for (let i = 0; i &lt; elements.length; i++) {
      let element = elements[i];
      if (parseInt(element.getAttribute('data-step')) === this.state.clock) {
        let content = element.querySelector('.content');
        let steps = element.querySelector('maki-steps');
        console.log('steps:', steps);
        content.innerHTML = `&lt;div class="ui message">
          &lt;h4 class="ui header">Verify Your Keys&lt;/h4>
          &lt;maki-canvas id="entropy-viewer">&lt;/maki-canvas>
          &lt;p>Double-check that the address matches your device and &lt;a href="">the transaction on the blockchain&lt;/a>.  &lt;div class="ui green right labeled icon button" data-action="_loadStepTwo">Next Step &lt;i class="right chevron icon">&lt;/i>&lt;/div>&lt;p>
        &lt;/div>`;
      }
    }
  }

  _advanceToLabeling (event) {
    event.preventDefault();

    this.status = 'advancing';

    let steps = this.querySelector('maki-steps');

    steps.state.clock = 2;
    steps.connectedCallback();

    this.status = 'labeling';
  }

  _advanceToKeyGeneration (event) {
    console.log('KEY GENERATION:', event, this);
    let self = this;

    self.status = 'advancing';

    let steps = this.querySelector('maki-steps');
    let element = document.querySelector('.maki-step[data-step="0"]');
    let content = element.querySelector('.content');

    console.log('element:', element);
    console.log('content:', content);

    let old = content.innerHTML;

    content.innerHTML = `&lt;h4>Generating key...&lt;/h4>
      &lt;button class="ui loading button">generating...&lt;/button>`;

    this.status = 'waiting';
    this.wallet._load().then(function (data) {
      let seed = self.wallet._getSeed();

      if (seed) {
        steps.state.clock = 1;

        let target = document.querySelector('.maki-step[data-step="1"]');
        let message = target.querySelector('.content');

        message.innerHTML = `&lt;h4>Your Wallet Seed&lt;/h4>
          &lt;p>Write this down and store it somewhere safe &amp; secure.  &lt;strong>Your funds will be permanently lost without this.&lt;/p>
          &lt;code>${seed}&lt;/code>
          &lt;button class="ui fluid right labeled icon button" data-action="_advanceToLabeling">I've saved this, move forward&lt;i class="right chevron icon">&lt;/i>&lt;/button>`;

        steps.connectedCallback();
      } else {
        content.innerHTML = old;
      }
    });

    this.status = 'loaded';
    steps.innerHTML = steps._getInnerHTML();
    // this.innerHTML = this._getInnerHTML();
  }

  _advanceToKeyRestoration (event) {
    console.log('KEY RESTORATION:', event, this);
    let self = this;

    let steps = this.querySelector('maki-steps');
    let element = document.querySelector('.maki-step[data-step="0"]');
    let content = element.querySelector('.content');

    console.log('element:', element);
    console.log('content:', content);

    let html = `&lt;h4>Provide Wallet Seed&lt;/h4>
      &lt;p>For improved security, turn off your network connection and ensure there are no cameras recording your screen.&lt;/p>
      &lt;select multiple class="ui fluid search multiple dropdown" name="seed" placeholder="Enter your 24-word restoration seed">&lt;option>&lt;/option>`;
    for (let i = 0; i &lt; this.wallet.words.length; i++) {
      let word = self.wallet.words[i];
      html += `&lt;option value="${word}">${word}&lt;/option>`;
    }
    html += `&lt;/select>
      &lt;button class="ui fluid right icon labeled button" data-action="_confirmSeedPhrase">Confirm &lt;i class="right chevron icon">&lt;/i>&lt;/button>`;

    content.innerHTML = html;
    steps.innerHTML = steps._getInnerHTML();

    $('.ui.dropdown').dropdown();
  }

  _confirmSeedPhrase (event) {
    event.preventDefault();

    this.state.clock = 1;

    let steps = this.querySelector('maki-steps');
    let element = document.querySelector('.maki-step[data-step="1"]');
    let content = element.querySelector('.content');

    content.innerHTML = `&lt;code>${this.wallet.seed}&lt;/code>
      &lt;button class="ui fluid button">Confirm&lt;/button>`;

    steps.innerHTML = steps._getInnerHTML();
  }

  async _publishIdentityAndCommitWallet (event) {
    event.preventDefault();

    $('.ui.modal').addClass('loading');

    let modal = document.querySelector('maki-modal');
    let account = this.wallet._getAccountByIndex(0);
    let identity = await this._publishIdentity(event);
    let wallet = await window.app._registerWallet({ account });


    modal._closeModal();
  }

  async _publishIdentity (event) {
    event.preventDefault();

    let modal = document.querySelector('maki-modal');
    let account = this.wallet._getAccountByIndex(0);
    let identity = null;

    try {
      let data = { id: account.address, address: account.address };
      let actor = await window.app._registerActor(data);
      let link = await window.app._POST('/identities', data);
      identity = Object.assign({
        link: link
      }, data);

      window.app._setIdentity(data);
    } catch (E) {
      console.error('Could not create identity:', E);
    }

    return identity;
  }

  connectedCallback () {
    super.connectedCallback();
    console.log('wallet creator attached!');

    window.app.circuit._registerMethod('_submitFormWithData', this._submitFormWithData.bind(this));
    window.app.circuit._registerMethod('_advanceToKeyGeneration', this._advanceToKeyGeneration.bind(this));
    window.app.circuit._registerMethod('_advanceToKeyRestoration', this._advanceToKeyRestoration.bind(this));
    window.app.circuit._registerMethod('_loadConfirmedPanel', this._loadConfirmedPanel.bind(this));
    window.app.circuit._registerMethod('_loadGeneratorPanel', this._loadGeneratorPanel.bind(this));
    window.app.circuit._registerMethod('_loadSuccessPanel', this._loadSuccessPanel.bind(this));
    window.app.circuit._registerMethod('_loadStepTwo', this._loadStepTwo.bind(this));
    window.app.circuit._registerMethod('_confirmSeedPhrase', this._confirmSeedPhrase.bind(this));
    window.app.circuit._registerMethod('_advanceToLabeling', this._advanceToLabeling.bind(this));
    window.app.circuit._registerMethod('_publishIdentity', this._publishIdentity.bind(this));
    window.app.circuit._registerMethod('_publishIdentityAndCommitWallet', this._publishIdentityAndCommitWallet.bind(this));

    let steps = this.querySelector('maki-steps');
    let progress = this.querySelector('maki-progress');

    console.log('FOUND STEPS:', steps);
    console.log('progress:', progress);

    steps.settings.steps = [
      {
        active: true,
        icon: 'lock',
        title: `Step 1: Insert Key`,
        description: 'Generate or restore from memory?',
        content: `&lt;h4>Insert Key&lt;/h4>
          &lt;div class="ui two buttons">
            &lt;div class="ui blue left labeled icon button" data-action="_advanceToKeyRestoration">&lt;i class="brain icon">&lt;/i>Restore from Memory&lt;/div>
            &lt;div class="or">or&lt;/div>
            &lt;div class="ui green right labeled icon button" data-action="_advanceToKeyGeneration">Generate New Key&lt;i class="right chevron icon">&lt;/i>&lt;/div>
          &lt;/div>`
      },
      {
        title: `Step 2: Verify`,
        icon: 'eye',
        description: 'Inspect the key.',
        content: '&lt;code data-bind="/seed">key to verify&lt;/code>'
      },
      {
        title: `Step 3: Set Name`,
        icon: 'settings',
        description: 'Give it a name!',
        content: `&lt;h4>Label This Wallet&lt;/h4>
        &lt;div>
          &lt;p>Set a local name.&lt;/p>
          &lt;form class="ui form">
            &lt;div class="field">
              &lt;label for="name">Name&lt;/label>
              &lt;input type="text" name="name" placeholder="Label for this wallet (local only)" class="required input" />&lt;button data-action="_publishIdentityAndCommitWallet" class="ui fluid right labeled green icon button">Save &amp; Open &lt;i class="icon right chevron">&lt;/i>&lt;/button>
            &lt;/div>
          &lt;/form>
        &lt;/div>`
      }
    ];

    steps.innerHTML = steps._getInnerHTML();
  }

  _getInnerHTML () {
    return `&lt;form class="ui fluid form" action="/wallets" method="POST" data-action="_submitFormWithData">
      &lt;maki-steps id="${this.settings.handle}-steps">&lt;/maki-steps>
    &lt;/form>`;
  }
}

module.exports = WalletCreator;
</code></pre>
        </article>
    </section>




    </div>
    <nav><h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="Application.html">Application</a></li><li><a href="Compiler.html">Compiler</a></li><li><a href="Component.html">Component</a></li><li><a href="Definition.html">Definition</a></li><li><a href="FabricComponent.html">FabricComponent</a></li><li><a href="FabricHTTPServer.html">FabricHTTPServer</a></li><li><a href="Hub.html">Hub</a></li><li><a href="Maki.html">Maki</a></li><li><a href="Modal.html">Modal</a></li><li><a href="Remote.html">Remote</a></li><li><a href="Router.html">Router</a></li><li><a href="SPA.html">SPA</a></li><li><a href="Stash.html">Stash</a></li><li><a href="Steps.html">Steps</a></li><li><a href="Wallet.html">Wallet</a></li><li><a href="WalletCard.html">WalletCard</a></li><li><a href="WalletCreator.html">WalletCreator</a></li></ul></nav>
    <br class="clear" />
    <footer>
        <a href="https://github.com/FabricLabs/web">git://</a> &middot; <a href="https://chat.fabric.pub/#/room/#web:fabric.pub">Community</a>
    </footer>
    <script> prettyPrint(); </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
